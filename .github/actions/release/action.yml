name: Release

description: Version and publish

inputs:
  github_token:
    description: GitHub token
    required: true
  npm_token:
    description: NPM token
    required: true

runs:
  using: composite
  steps:
    - name: Version
      shell: bash
      run: npx nx affected --target=version --base=last-release
    - name: Tag last-release
      if: always()
      shell: bash
      run: git tag -f last-release
    - name: Push changes
      if: always()
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ inputs.github_token }}
        branch: ${{ github.ref }}
        force: true
        tags: true
    - name: Publish NPM
      if: always()
      shell: bash
      run: npx nx affected --target=publish-npm --base=last-release
      env:
        NODE_AUTH_TOKEN: ${{ inputs.npm_token }}
    - name: Publish Github
      if: always()
      shell: bash
      run: npx nx affected --target=publish-github --base=last-release
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
